# Имя workflow
name: Main Taski Workflow
# Перечень событий-триггеров, при которых должен запускаться workflow
on:
  #Ключ on описывает триггер — событие, 
  #которое должно произойти, чтобы workflow начал выполняться.
  push:
    # Отслеживаем изменения только в ветке main
    branches:
      - main
# Перечень задач
jobs:
    #список действий, которые должны выполниться 
    #после срабатывания триггера
    tests:
        #Разворачиваем окружение
        runs-on: ubuntu-latest
        #runs-on, определяет, в каком окружении будут запущены все команды 
        #этой задачи. Окружение создаёт на своём сервере GitHub Actions.
        services:
            postgres:
                #запускаем контейнер из образа
                image: postgres:13.10
                # Указываем имя тестовой базы, имя и пароль пользователя в открытом виде,
                # ведь эта база будет работать только во время прогона тестов
                env:
                    POSTGRES_USER: django_user
                    POSTGRES_PASSWORD: django_password
                    POSTGRES_DB: django_db
                ports:
                    - 5432:5432
                # Эта конструкция описывает проверку готовности сервиса postgres
                # Если её не будет, то тесты могут запуститься раньше, чем сервер PostgreSQL
                # В результате тесты опять решат, что базы нет, — и упадут
                options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        steps:
            #Каждый шаг — это отдельная команда.
            #Копируем код проекта
            - name: Check out code
              uses: actions/checkout@v3 # Берём готовое решение из библиотеки GitHub Actions
            #Устанавливаем Python с помощью action
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: 3.9 # В action setup-python@v4 передаём параметр — версию Python
            # Обновляем pip, устанавливаем flake8 (инструмент для проверки кода PEP 8) и flake8-isort (расширение проверяет правильность сортировки импортов в коде), 
            # устанавливаем зависимости проекта
            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install flake8==6.0.0 flake8-isort==6.0.0
                pip install -r ./backend/requirements.txt 
            # Чтобы запустить тесты, нужно установить зависимости    
            # Запускаем flake8
            - name: Test with flake8 and django tests
              # Вызываем flake8 и указываем ему,
              # что нужно проверить файлы только в папке backend/
              run: |
                python -m flake8 backend/
                cd backend/
                python manage.py test 
            #В ключе run хранится команда, которая будет выполнена в терминале 
            #окружения на раннере